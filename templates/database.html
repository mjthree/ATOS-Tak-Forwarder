<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APEX SHIELD - ATOS TAK Forwarder - Database Interface</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css">
    <style>
        body {font-family: Arial, sans-serif;background:#f5f5f5;margin:0;padding:0;}
        .nav-bar{background:#34495e;color:#fff;padding:10px 20px;margin:0 0 20px 0;}
        .nav-bar a{color:#fff;text-decoration:none;padding:10px 15px;margin:0 5px;border-radius:5px;transition:background 0.3s;}
        .nav-bar a:hover{background:#2c3e50;}
        .nav-bar a.active{background:#2c3e50;font-weight:bold;}
        .header{background:#2c3e50;color:#fff;padding:20px;margin:0 0 20px 0;}
        .container{max-width:900px;margin:0 auto;padding:20px;}
        #chart-container{background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px #0001;}
        #slider{margin:30px 0;}
        .export-btn{margin-right:10px;}
        .company-brand{font-size:0.9em;opacity:0.8;margin-top:5px;}
    </style>
</head>
<body>
<div class="nav-bar">
    <a href="/">üè† Main Control</a>
    <a href="/display">üìä Display Dashboard</a>
    <a href="/database" class="active">üìà Database Interface</a>
</div>
<div class="header">
    <h1>üìä APEX SHIELD - ATOS Database Explorer</h1>
    <div class="company-brand">Historical Data Analysis & Export</div>
</div>
<div class="container">
    <label for="tag-select">Select Tag(s):</label>
    <select id="tag-select" multiple size="5"></select>
    <label for="minutes-back" style="margin-left:20px;">Previous minutes:</label>
    <input type="number" id="minutes-back" value="30" min="1" style="width:70px;">
    <button id="minutes-submit">Submit</button>
    <div id="slider"></div>
    <div id="chart-container">
        <canvas id="altitude-chart" height="300"></canvas>
    </div>
    <div style="margin-top:20px;">
        <label for="kml-color">KML Line Color:</label>
        <select id="kml-color">
            <option value="ff0000ff">Red</option>
            <option value="ff00ff00">Green</option>
            <option value="ffff0000">Blue</option>
            <option value="ff00ffff">Yellow</option>
            <option value="ffff00ff">Magenta</option>
            <option value="ffffff00">Cyan</option>
            <option value="ff008cff">Orange</option>
            <option value="ff800080">Purple</option>
            <option value="ffcc99ff">Pink</option>
            <option value="ff336699">Brown</option>
            <option value="ff888888">Gray</option>
            <option value="ff000000">Black</option>
            <option value="ffffffff">White</option>
            <option value="ff00ff80">Lime</option>
            <option value="ff808000">Teal</option>
            <option value="ff008080">Olive</option>
            <option value="ff800000">Navy</option>
            <option value="ff000080">Maroon</option>
            <option value="ffc0c0c0">Silver</option>
            <option value="ff00d7ff">Gold</option>
            <option value="ffdcdcdc">Beige</option>
            <option value="ff507fff">Coral</option>
            <option value="ff8234b0">Indigo</option>
            <option value="ffb4a020">Khaki</option>
            <option value="ffe6e6fa">Lavender</option>
            <option value="ffbdfcc9">Mint</option>
            <option value="ffaaddee">Peach</option>
            <option value="ff7280fa">Salmon</option>
            <option value="ffd0e040">Turquoise</option>
            <option value="ffee82ee">Violet</option>
            <option value="ff3c14dc">Crimson</option>
            <option value="ffd4ff7f">Aquamarine</option>
            <option value="ffdda0dd">Plum</option>
            <option value="ffdb70db">Orchid</option>
            <option value="ff1e69d2">Chocolate</option>
            <option value="fffff0ff">Azure</option>
            <option value="fff0ffff">Ivory</option>
            <option value="fffafaff">Snow</option>
            <option value="ff4763ff">Tomato</option>
            <option value="ffb3def5">Wheat</option>
            <option value="ff908070">SlateGray</option>
            <option value="ff578b2e">SeaGreen</option>
            <option value="ffffd700">SkyBlue</option>
            <option value="ff7fff00">SpringGreen</option>
            <option value="ff8cb4d2">Tan</option>
            <option value="ffd8bfd8">Thistle</option>
            <option value="ff8f8fbc">RosyBrown</option>
            <option value="ff2d52a0">Sienna</option>
            <option value="ffb469ff">HotPink</option>
            <option value="ffffe0ff">LightBlue</option>
        </select>
        <label for="dz-altitude" style="margin-left:20px;">DZ Altitude:</label>
        <input type="number" id="dz-altitude" value="1893" min="0" style="width:80px;">
        <button class="export-btn" id="export-csv">Export CSV</button>
        <button class="export-btn" id="export-kml">Export KML</button>
        <button class="export-btn" id="open-in-map">Open in Map</button>
    </div>
</div>
<script>
let tagList = [];
let tagData = [];
let chart = null;
let slider = null;
let sliderRange = [0, 0];
let sliderTimestamps = [];
let sliderReady = false;
let dataReady = false;
let minutesBack = 30;

function fetchTags() {
    fetch('/api/db/tags').then(r => r.json()).then(tags => {
        tagList = tags;
        const sel = document.getElementById('tag-select');
        sel.innerHTML = '';
        tags.forEach(t => {
            const o = document.createElement('option');
            o.value = t;
            o.text = t;
            sel.appendChild(o);
        });
        if (tags.length > 0) {
            sel.value = tags[0];
            fetchTagData(tags[0], minutesBack);
        }
    });
}

function fetchTagData(tagId, minutes) {
    dataReady = false;
    let url = `/api/db/tag_data?tag_id=${tagId}`;
    if (minutes) url += `&minutes=${minutes}`;
    fetch(url)
        .then(r => r.json())
        .then(data => {
            tagData = data;
            console.log('Fetched tagData:', tagData);
            dataReady = true;
            // Always reset slider and chart to match new data
            slider = null;
            sliderTimestamps = [];
            sliderRange = [0, 0];
            drawChart();
            setupSlider();
        });
}

document.getElementById('tag-select').onchange = function() {
    fetchTagData(this.value, minutesBack);
};

document.getElementById('minutes-submit').onclick = function() {
    minutesBack = parseInt(document.getElementById('minutes-back').value) || 30;
    const tagId = document.getElementById('tag-select').value;
    fetchTagData(tagId, minutesBack);
};

function drawChart() {
    if (!tagData || tagData.length === 0) return;
    const ctx = document.getElementById('altitude-chart').getContext('2d');
    if (chart) { chart.destroy(); chart = null; }
    const labels = tagData.map(d => d.timestamp);
    const altitudes = tagData.map(d => Number(d.altitude_ft));
    console.log('labels:', labels);
    console.log('altitudes:', altitudes);
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Altitude (ft)',
                data: altitudes,
                borderColor: '#0074D9',
                backgroundColor: 'rgba(0,116,217,0.1)',
                pointRadius: 1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: { type: 'time', time: { unit: 'minute' }, title: { display: true, text: 'Time' } },
                y: { title: { display: true, text: 'Altitude (ft)' } }
            }
        }
    });
}

function setupSlider() {
    sliderReady = false;
    const sliderDiv = document.getElementById('slider');
    sliderDiv.innerHTML = '';
    if (tagData.length < 2) return;
    sliderTimestamps = tagData.map(d => new Date(d.timestamp).getTime());
    sliderRange = [0, sliderTimestamps.length - 1];
    sliderDiv.innerHTML = '<div id="slider-el"></div>';
    slider = document.getElementById('slider-el');
    noUiSlider.create(slider, {
        start: sliderRange,
        connect: true,
        range: { min: 0, max: sliderTimestamps.length - 1 },
        step: 1,
        tooltips: [true, true],
        format: {
            to: i => new Date(sliderTimestamps[Math.round(i)]).toLocaleString(),
            from: Number
        }
    });
    slider.noUiSlider.on('update', function(values, handle) {
        if (dataReady) zoomChartToSlider();
    });
    sliderReady = true;
    if (dataReady) zoomChartToSlider();
}

function zoomChartToSlider() {
    if (!slider || tagData.length < 2) return;
    let [startIdx, endIdx] = slider.noUiSlider.get().map((_,i) => Math.round(slider.noUiSlider.get()[i]));
    // Clamp indices to valid range
    startIdx = Math.max(0, Math.min(startIdx, tagData.length - 1));
    endIdx = Math.max(0, Math.min(endIdx, tagData.length - 1));
    if (startIdx > endIdx) [startIdx, endIdx] = [endIdx, startIdx];
    // If slider is at full range, show all data
    if (startIdx === 0 && endIdx === tagData.length - 1) {
        drawChart();
        return;
    }
    const zoomedData = tagData.slice(startIdx, endIdx + 1);
    if (zoomedData.length === 0) return;
    const ctx = document.getElementById('altitude-chart').getContext('2d');
    if (chart) { chart.destroy(); chart = null; }
    const labels = zoomedData.map(d => d.timestamp);
    const altitudes = zoomedData.map(d => Number(d.altitude_ft));
    console.log('labels:', labels);
    console.log('altitudes:', altitudes);
    const xMin = tagData[startIdx]?.timestamp || tagData[0].timestamp;
    const xMax = tagData[endIdx]?.timestamp || tagData[tagData.length-1].timestamp;
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Altitude (ft)',
                data: altitudes,
                borderColor: '#0074D9',
                backgroundColor: 'rgba(0,116,217,0.1)',
                pointRadius: 1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    type: 'time',
                    time: { unit: 'minute' },
                    title: { display: true, text: 'Time' },
                    min: xMin,
                    max: xMax
                },
                y: { title: { display: true, text: 'Altitude (ft)' } }
            }
        }
    });
}

function getSliderTimeRange() {
    if (!slider || tagData.length < 2) return [null, null];
    let [startIdx, endIdx] = slider.noUiSlider.get().map((_,i) => Math.round(slider.noUiSlider.get()[i]));
    // Clamp indices to valid range
    startIdx = Math.max(0, Math.min(startIdx, tagData.length - 1));
    endIdx = Math.max(0, Math.min(endIdx, tagData.length - 1));
    if (startIdx > endIdx) [startIdx, endIdx] = [endIdx, startIdx];
    let start = tagData[startIdx]?.timestamp;
    let end = tagData[endIdx]?.timestamp;
    // Fallback if indices are still invalid
    if (!start) start = tagData[0]?.timestamp;
    if (!end) end = tagData[tagData.length-1]?.timestamp;
    console.log('Slider:', slider, 'tagData.length:', tagData.length);
    console.log('Slider get:', slider ? slider.noUiSlider.get() : null);
    console.log('tagData[0]:', tagData[0], 'tagData[tagData.length-1]:', tagData[tagData.length-1]);
    console.log('Computed start/end:', start, end);
    return [start, end];
}

document.getElementById('export-csv').onclick = function() {
    const tagId = document.getElementById('tag-select').value;
    if (!slider || tagData.length < 2) {
        alert('Slider not ready or not enough data to export.');
        return;
    }
    const [start, end] = getSliderTimeRange();
    if (!start || !end) {
        alert('Unable to determine slider range for export.');
        return;
    }
    const dzAltitude = parseFloat(document.getElementById('dz-altitude').value) || 0;
    let url = `/api/db/export_csv?tag_id=${tagId}`;
    url += `&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}&dz_altitude=${dzAltitude}`;
    console.log('Export CSV URL:', url);
    window.open(url, '_blank');
};

document.getElementById('export-kml').onclick = function() {
    const tagSelect = document.getElementById('tag-select');
    const selected = Array.from(tagSelect.selectedOptions).map(opt => opt.value);
    if (selected.length === 0) {
        alert('Please select at least one tag.');
        return;
    }
    if (!slider || tagData.length < 2) {
        alert('Slider not ready or not enough data to export.');
        return;
    }
    const [start, end] = getSliderTimeRange();
    if (!start || !end) {
        alert('Unable to determine slider range for export.');
        return;
    }
    const color = document.getElementById('kml-color').value;
    const dzAltitude = parseFloat(document.getElementById('dz-altitude').value) || 0;
    let url = `/api/db/export_kml?tag_id=${selected.join(',')}&color=${color}`;
    url += `&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}&dz_altitude=${dzAltitude}`;
    console.log('Export KML URL:', url);
    window.open(url, '_blank');
};

document.getElementById('open-in-map').onclick = function() {
    const tagId = document.getElementById('tag-select').value;
    if (!slider || tagData.length < 2) {
        alert('Slider not ready or not enough data to export.');
        return;
    }
    const [start, end] = getSliderTimeRange();
    if (!start || !end) {
        alert('Unable to determine slider range for export.');
        return;
    }
    const dzAltitude = parseFloat(document.getElementById('dz-altitude').value) || 0;
    let url = `/view_kml?tag_id=${tagId}`;
    url += `&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}&dz_altitude=${dzAltitude}`;
    window.open(url, '_blank');
};

fetchTags();
</script>
</body>
</html> 